# Docker Compose for Money Map Manager
# Start with: docker compose up -d
# Stop with: docker compose down

services:
  # ============================================
  # Backend: FastAPI + SQLite
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: moneymap-backend
    ports:
      - "8000:8000"
    volumes:
      # Persist SQLite database across container restarts.
      - ./data:/app/data
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-opus-4-6}
      - DATABASE_URL=sqlite:///./data/moneymap.db
      - FRONTEND_URL=http://localhost:4000
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # Frontend: Next.js
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # API URL baked into the build for client-side requests.
        # Override with NEXT_PUBLIC_API_URL env var for non-localhost deployments.
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
    container_name: moneymap-frontend
    ports:
      - "4000:3000"
    environment:
      - NODE_ENV=production
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "bun",
          "--eval",
          "fetch('http://localhost:3000').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

# Named volumes (alternative to bind mount).
# Uncomment to use Docker-managed volume instead of ./data.
volumes:
  moneymap-data:
